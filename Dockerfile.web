# ==========================================================
# Dockerfile pour le n8n principal (Web + Broker)
# ==========================================================
FROM node:20-bullseye

WORKDIR /app

RUN npm install -g pnpm

COPY package.json ./
RUN pnpm install --frozen-lockfile
COPY . .
RUN pnpm run build:n8n

# Config n8n
ENV N8N_PORT=5678
ENV N8N_HOST=0.0.0.0
ENV N8N_RUNNERS_ENABLED=true
ENV N8N_RUNNERS_MODE=external
ENV N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
ENV N8N_TASK_BROKER_TYPE=redis
ENV N8N_TASK_BROKER_REDIS_HOST=${REDIS_HOST}
ENV N8N_TASK_BROKER_REDIS_PORT=6379
ENV N8N_TASK_BROKER_REDIS_PASSWORD=${REDIS_PASSWORD}
ENV N8N_LOG_LEVEL=info

EXPOSE 5678

CMD ["pnpm", "start"]
